# .github/workflows/deploy-to-snowflake.yml
name: CI/CD ‚Üí Snowflake

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js (for sf CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install sf CLI
        run: npm install -g @snowflake-labs/sf

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          check-latest: false

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          # Install Mike Farah's yq (pure-Go) which supports -r
          sudo wget -O /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate YAML from SQL
        run: python scripts/sql_to_yaml.py

      - name: Deploy to Snowflake with sf CLI
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PWD:       ${{ secrets.SNOWFLAKE_PWD }}
          SNOWFLAKE_ROLE:      ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE:  ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA:    ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          echo "‚ñ∂Ô∏è Streaming SQL into Snowflake via sf CLI‚Ä¶"
          # Extract all custom_TSQL statements and pipe into sf
          yq -r '.[] .custom_TSQL' *.yaml \
            | sf query execute \
                --account-name $SNOWFLAKE_ACCOUNT \
                --username     $SNOWFLAKE_USER \
                --password     $SNOWFLAKE_PWD \
                --role         $SNOWFLAKE_ROLE \
                --warehouse    $SNOWFLAKE_WAREHOUSE \
                --database     $SNOWFLAKE_DATABASE \
                --schema       $SNOWFLAKE_SCHEMA \
                --sql-body     -

      - name: Success notification
        if: success()
        run: echo "üéâ Deployed to Snowflake successfully!"
